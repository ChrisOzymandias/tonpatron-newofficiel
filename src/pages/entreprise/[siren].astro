---
import { Astro } from 'astro';

export async function getStaticPaths() {
  // On ne pré-génère aucune page, elles seront générées à la volée (SSG fallback)
  return [];
}

export async function get({ params }) {
  const siren = params.siren;
  const apiUrl = `https://recherche-entreprises.api.gouv.fr/entreprises/${siren}`;
  let data = null;
  let notFound = false;
  let error = null;
  try {
    const res = await fetch(apiUrl);
    if (!res.ok) {
      notFound = true;
    } else {
      data = await res.json();
    }
  } catch (e) {
    notFound = true;
    error = e.toString();
  }
  return {
    props: {
      entreprise: data,
      siren,
      notFound,
      error
    }
  };
}
---
<!-- Debug minimal -->
<pre style="background:#f6f8fa;padding:1em;overflow:auto;max-width:100vw;max-height:200px;">{JSON.stringify({params: Astro.params, props: Astro.props}, null, 2)}</pre>

{Astro.props.notFound || Astro.props.error ? (
  <section class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-16 mb-12 text-center">
    <h1 class="text-3xl font-extrabold text-red-700 mb-4">Entreprise introuvable</h1>
    <p class="text-gray-700 mb-2">Impossible d'afficher la fiche de cette entreprise. Elle n'existe pas, a été supprimée, ou une erreur s'est produite lors de la récupération des données.</p>
    {Astro.props.error && <div class="text-xs text-red-500 mt-2">Détail technique : {Astro.props.error}</div>}
    <a href="/entreprises" class="inline-block mt-6 px-5 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow hover:bg-blue-700 transition">Retour à la liste des entreprises</a>
  </section>
) : (
  <>
    <head>
      <title>{Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet} | Fiche entreprise | TonPatron</title>
      <meta name="description" content={`Fiche entreprise de ${Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet} (SIREN : ${Astro.props.siren}). Adresse : ${Astro.props.entreprise.siege?.adresse_ligne_1 || ''}, ${Astro.props.entreprise.siege?.libelle_commune || ''}. Retrouvez les informations légales, SIREN, secteur et plus.`} />
      <meta property="og:title" content={`${Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet} | TonPatron`} />
      <meta property="og:description" content={`Découvrez les informations clés sur ${Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet}, SIREN ${Astro.props.siren}, secteur : ${Astro.props.entreprise.activite_principale_libelle || ''}.`} />
      <meta property="og:type" content="website" />
      <meta property="og:url" content={`https://tonpatron.fr/entreprise/${Astro.props.siren}`} />
      <meta name="robots" content="index, follow" />
      <link rel="canonical" href={`https://tonpatron.fr/entreprise/${Astro.props.siren}`} />
    </head>
    <section class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-16 mb-12">
      <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 mb-4">{Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet}</h1>
      <div class="text-gray-700 mb-2"><span class="font-semibold">SIREN :</span> {Astro.props.siren}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Adresse :</span> {Astro.props.entreprise.siege?.adresse_ligne_1}, {Astro.props.entreprise.siege?.libelle_commune} {Astro.props.entreprise.siege?.code_postal}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Secteur d'activité :</span> {Astro.props.entreprise.activite_principale_libelle}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Date de création :</span> {Astro.props.entreprise.date_creation}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Statut :</span> {Astro.props.entreprise.etat_administratif}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Effectif :</span> {Astro.props.entreprise.tranche_effectif_salarie}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Forme juridique :</span> {Astro.props.entreprise.categorie_juridique}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Code NAF :</span> {Astro.props.entreprise.activite_principale}
      </div>
      <div class="mt-8">
        <a href={`https://annuaire-entreprises.data.gouv.fr/entreprise/${Astro.props.siren}`} target="_blank" rel="noopener" class="text-blue-600 hover:underline">Voir la fiche officielle</a>
      </div>
    </section>
  </>
)}
