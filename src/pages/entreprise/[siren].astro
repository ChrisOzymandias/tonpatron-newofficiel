---
import { Astro } from 'astro';

export async function getStaticPaths() {
  // On ne pré-génère aucune page, elles seront générées à la volée (SSG fallback)
  return [];
}

export async function get({ params }) {
  const siren = params.siren;
  const apiUrl = `https://recherche-entreprises.api.gouv.fr/entreprises/${siren}`;
  const res = await fetch(apiUrl);
  if (!res.ok) {
    return { props: { notFound: true } };
  }
  const data = await res.json();
  return {
    props: {
      entreprise: data,
      siren
    }
  };
}
---

{!Astro.props.notFound ? (
  <>
    <head>
      <title>{Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet} | Fiche entreprise | TonPatron</title>
      <meta name="description" content={`Fiche entreprise de ${Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet} (SIREN : ${Astro.props.siren}). Adresse : ${Astro.props.entreprise.siege?.adresse_ligne_1 || ''}, ${Astro.props.entreprise.siege?.libelle_commune || ''}. Retrouvez les informations légales, SIREN, secteur et plus.`} />
      <meta property="og:title" content={`${Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet} | TonPatron`} />
      <meta property="og:description" content={`Découvrez les informations clés sur ${Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet}, SIREN ${Astro.props.siren}, secteur : ${Astro.props.entreprise.activite_principale_libelle || ''}.`} />
      <meta property="og:type" content="website" />
      <meta property="og:url" content={`https://tonpatron.fr/entreprise/${Astro.props.siren}`} />
      <meta name="robots" content="index, follow" />
      <link rel="canonical" href={`https://tonpatron.fr/entreprise/${Astro.props.siren}`} />
    </head>
    <section class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-16 mb-12">
      <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700 mb-4">{Astro.props.entreprise.nom_raison_sociale || Astro.props.entreprise.nom_complet}</h1>
      <div class="text-gray-700 mb-2"><span class="font-semibold">SIREN :</span> {Astro.props.siren}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Adresse :</span> {Astro.props.entreprise.siege?.adresse_ligne_1}, {Astro.props.entreprise.siege?.libelle_commune} {Astro.props.entreprise.siege?.code_postal}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Secteur d'activité :</span> {Astro.props.entreprise.activite_principale_libelle}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Date de création :</span> {Astro.props.entreprise.date_creation}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Statut :</span> {Astro.props.entreprise.etat_administratif}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Effectif :</span> {Astro.props.entreprise.tranche_effectif_salarie}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Forme juridique :</span> {Astro.props.entreprise.categorie_juridique}</div>
      <div class="text-gray-700 mb-2"><span class="font-semibold">Code NAF :</span> {Astro.props.entreprise.activite_principale}
      </div>
      <div class="mt-8">
        <a href={`https://annuaire-entreprises.data.gouv.fr/entreprise/${Astro.props.siren}`} target="_blank" rel="noopener" class="text-blue-600 hover:underline">Voir la fiche officielle</a>
      </div>
    </section>
  </>
) : (
  <section class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-16 mb-12">
    <h1 class="text-2xl font-bold text-red-700 mb-4">Entreprise non trouvée</h1>
    <p class="mb-4">Cette entreprise n'existe pas dans l'annuaire officiel ou une erreur est survenue.</p>
    <a href={`/entreprise/${encodeURIComponent(Astro.url.searchParams.get('nom') || 'entreprise')}/${Astro.params.siren}/creer`} class="text-blue-600 hover:underline">Créer une fiche entreprise</a>
  </section>
)}
